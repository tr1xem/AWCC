name: Release Please & Build Tarball

on:
    push:
        branches:
            - master
            - main
    release:
        types: [created]

jobs:
    release-please:
        runs-on: ubuntu-latest
        if: github.event_name == 'push'
        permissions:
            contents: write
            pull-requests: write
            issues: write
        steps:
            - uses: googleapis/release-please-action@v4
              with:
                  token: ${{ secrets.TOKEN_GITHUB }}
            - uses: actions/checkout@v4
            - name: tag stable versions
              if: ${{ steps.release.outputs.release_created }}
              run: |
                  git config user.name github-actions[bot]
                  git config user.email github-actions[bot]@users.noreply.github.com
                  git remote add gh-token "https://${{ secrets.TOKEN_GITHUB }}@github.com/google-github-actions/release-please-action.git"
                  git tag -d stable || true
                  git push origin :stable || true
                  git tag -a stable -m "Last Stable Release"
                  git push origin stable

    build-and-upload:
        runs-on: ubuntu-latest
        if: github.event_name == 'release'
        steps:
            - uses: actions/checkout@v4

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y acpi-call-dkms git make cmake libusb-1.0-0-dev libglfw3-dev libx11-dev libgl-dev libevdev-dev pkgconf g++-13

            - name: Build AWCC
              run: |
                  mkdir build
                  cd build
                  cmake ..
                  make
                  cd ..

            - name: Prepare release files
              run: |
                  mkdir release
                  cp build/awcc release/
                  cp -r app release/
                  cp LICENSE release/

            - name: Create tarball with awcc binary, app folder, and LICENSE
              run: |
                  tar -czvf AWCC-${{ github.event.release.tag_name }}.tar.gz -C release .

            - name: Upload tarball as release asset
              uses: softprops/action-gh-release@v2
              with:
                  files: AWCC-${{ github.event.release.tag_name }}.tar.gz
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
